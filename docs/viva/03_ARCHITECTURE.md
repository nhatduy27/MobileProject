# ğŸ—ï¸ KIáº¾N TRÃšC - KTX Delivery App
> **TÃ i liá»‡u Viva - Phase 1**  
> **Cáº­p nháº­t láº§n cuá»‘i:** 30 thÃ¡ng 1, 2026

---

## 1. Tá»”NG QUAN KIáº¾N TRÃšC Há»† THá»NG

### 1.1 Bá»©c tranh tá»•ng thá»ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           KTX DELIVERY SYSTEM                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚   ğŸ“± Android  â”‚     â”‚  ğŸ–¥ï¸ Admin     â”‚     â”‚   ğŸ”§ Firebase         â”‚    â”‚
â”‚   â”‚   App         â”‚     â”‚   Dashboard   â”‚     â”‚   Console             â”‚    â”‚
â”‚   â”‚               â”‚     â”‚               â”‚     â”‚                       â”‚    â”‚
â”‚   â”‚  â€¢ Customer   â”‚     â”‚  â€¢ React +    â”‚     â”‚  â€¢ Project Settings   â”‚    â”‚
â”‚   â”‚  â€¢ Owner      â”‚     â”‚    Vite       â”‚     â”‚  â€¢ User Management    â”‚    â”‚
â”‚   â”‚  â€¢ Shipper    â”‚     â”‚  â€¢ TypeScript â”‚     â”‚  â€¢ Firestore Rules    â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚           â”‚    HTTPS/REST       â”‚    HTTPS/REST                            â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚           â–¼                     â–¼                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                   â˜ï¸ FIREBASE CLOUD FUNCTIONS                    â”‚      â”‚
â”‚   â”‚                                                                  â”‚      â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚
â”‚   â”‚   â”‚                  NestJS Backend API                     â”‚   â”‚      â”‚
â”‚   â”‚   â”‚                                                         â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚  Auth   â”‚ â”‚  Users  â”‚ â”‚  Shops  â”‚ â”‚  Products   â”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚  Module     â”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚                                                         â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚ Orders  â”‚ â”‚  GPS    â”‚ â”‚ Wallet  â”‚ â”‚Notificationsâ”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚  Module     â”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚                                                         â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚Vouchers â”‚ â”‚ Chatbot â”‚ â”‚    + 15 more modules    â”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚                         â”‚ â”‚   â”‚      â”‚
â”‚   â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚      â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚                                       â”‚
â”‚                                     â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                      FIREBASE SERVICES                           â”‚      â”‚
â”‚   â”‚                                                                  â”‚      â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚   â”‚   â”‚ Firebase â”‚  â”‚Firestore â”‚  â”‚ Firebase â”‚  â”‚   Firebase   â”‚  â”‚      â”‚
â”‚   â”‚   â”‚   Auth   â”‚  â”‚ Database â”‚  â”‚ Storage  â”‚  â”‚     FCM      â”‚  â”‚      â”‚
â”‚   â”‚   â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚              â”‚  â”‚      â”‚
â”‚   â”‚   â”‚â€¢ Users   â”‚  â”‚â€¢ users   â”‚  â”‚â€¢ Images  â”‚  â”‚â€¢ Push Notifs â”‚  â”‚      â”‚
â”‚   â”‚   â”‚â€¢ Tokens  â”‚  â”‚â€¢ shops   â”‚  â”‚â€¢ Files   â”‚  â”‚â€¢ Topics      â”‚  â”‚      â”‚
â”‚   â”‚   â”‚â€¢ Roles   â”‚  â”‚â€¢ orders  â”‚  â”‚          â”‚  â”‚              â”‚  â”‚      â”‚
â”‚   â”‚   â”‚          â”‚  â”‚â€¢ trips   â”‚  â”‚          â”‚  â”‚              â”‚  â”‚      â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 TÃ³m táº¯t Tech Stack

| Táº§ng (Layer) | CÃ´ng nghá»‡ | Má»¥c Ä‘Ã­ch |
|-------|------------|---------|
| **Mobile Client** | Kotlin + Jetpack Compose | á»¨ng dá»¥ng Android gá»‘c |
| **Web Admin** | React + Vite + TypeScript | Báº£ng Ä‘iá»u khiá»ƒn quáº£n trá»‹ |
| **API Gateway** | Firebase Cloud Functions | LÆ°u trá»¯ serverless |
| **Backend** | NestJS + TypeScript | Logic nghiá»‡p vá»¥ |
| **Database** | Cloud Firestore | CÆ¡ sá»Ÿ dá»¯ liá»‡u NoSQL |
| **Auth** | Firebase Authentication | Quáº£n lÃ½ Ä‘á»‹nh danh |
| **Storage** | Firebase Storage | LÆ°u trá»¯ file/áº£nh |
| **Push** | Firebase Cloud Messaging | ThÃ´ng bÃ¡o Ä‘áº©y |

---

## 2. KIáº¾N TRÃšC á»¨NG Dá»¤NG ANDROID

### 2.1 MÃ´ hÃ¬nh MVVM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KIáº¾N TRÃšC MVVM                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                      Táº¦NG UI (UI LAYER)                     â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚    â”‚  â”‚               CÃ¡c mÃ n hÃ¬nh Jetpack Compose             â”‚ â”‚    â”‚
â”‚    â”‚  â”‚                                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ LoginScreen.kt      â€¢ HomeScreen.kt                 â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ ShopDetailScreen.kt â€¢ CartScreen.kt                 â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ OrderTrackingScreen.kt                              â”‚ â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚    â”‚                           â”‚                                 â”‚    â”‚
â”‚    â”‚                           â”‚ quan sÃ¡t StateFlow              â”‚    â”‚
â”‚    â”‚                           â–¼                                 â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                Táº¦NG VIEWMODEL (VIEWMODEL LAYER)             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚    â”‚  â”‚                    ViewModels                          â”‚ â”‚    â”‚
â”‚    â”‚  â”‚                                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ LoginViewModel      â€¢ HomeViewModel                 â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ ShopDetailViewModel â€¢ CartViewModel                 â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ GpsViewModel                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚                                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â”‚ MutableState   â”‚  â”‚  hÃ m suspend                â”‚   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â”‚ Flow<UiState>  â”‚  â”‚  viewModelScope.launch {}   â”‚   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚    â”‚                           â”‚                                 â”‚    â”‚
â”‚    â”‚                           â”‚ gá»i                             â”‚    â”‚
â”‚    â”‚                           â–¼                                 â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚              Táº¦NG REPOSITORY (REPOSITORY LAYER)             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚    â”‚  â”‚                   Repositories                         â”‚ â”‚    â”‚
â”‚    â”‚  â”‚                                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ UserFirebaseRepository   â€¢ OrderFirebaseRepository  â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ ShopFirebaseRepository   â€¢ CartFirebaseRepository   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ AuthRepository           â€¢ NotificationRepository   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚                                                        â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  trá»«u tÆ°á»£ng hÃ³a nguá»“n dá»¯ liá»‡u (API vs Firestore)       â”‚ â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚    â”‚                           â”‚                                 â”‚    â”‚
â”‚    â”‚                           â”‚ gá»i                             â”‚    â”‚
â”‚    â”‚                           â–¼                                 â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                 Táº¦NG Dá»® LIá»†U (DATA LAYER)                   â”‚    â”‚
â”‚    â”‚                                                              â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚    â”‚  â”‚   Remote (API)        â”‚  â”‚   Local (Firestore SDK)   â”‚  â”‚    â”‚
â”‚    â”‚  â”‚                       â”‚  â”‚                           â”‚  â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ ApiClient.kt       â”‚  â”‚  â€¢ FirebaseFirestore      â”‚  â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ Retrofit Services  â”‚  â”‚  â€¢ Firebase SDK           â”‚  â”‚    â”‚
â”‚    â”‚  â”‚  â€¢ DTOs               â”‚  â”‚  â€¢ TrÃ¬nh láº¯ng nghe trá»±c tiáº¿pâ”‚  â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚    â”‚              â”‚                         â”‚                    â”‚    â”‚
â”‚    â”‚              â–¼                         â–¼                    â”‚    â”‚
â”‚    â”‚         HTTPS/REST              Firebase SDK                â”‚    â”‚
â”‚    â”‚              â”‚                         â”‚                    â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                         â”‚                         â”‚
â”‚                   â–¼                         â–¼                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                  â˜ï¸ FIREBASE BACKEND                        â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tham kháº£o:** `FoodApp/ARCHITECTURE.md`

### 2.2 Cáº¥u trÃºc dá»± Ã¡n Android

```
FoodApp/app/src/main/java/com/example/foodapp/
â”‚
â”œâ”€â”€ authentication/              # ğŸ” Luá»“ng xÃ¡c thá»±c
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”œâ”€â”€ LoginScreen.kt       # UI (Compose)
â”‚   â”‚   â”œâ”€â”€ LoginViewModel.kt    # State + Logic
â”‚   â”‚   â””â”€â”€ state/
â”‚   â”‚       â””â”€â”€ LogInState.kt    # Sealed class states
â”‚   â””â”€â”€ signup/
â”‚       â”œâ”€â”€ SignUpScreen.kt
â”‚       â””â”€â”€ SignUpViewModel.kt
â”‚
â”œâ”€â”€ data/                        # ğŸ“¦ Táº§ng dá»¯ liá»‡u
â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ ApiClient.kt     # Retrofit instance
â”‚   â”‚   â”‚   â””â”€â”€ AuthService.kt   # API interface
â”‚   â”‚   â””â”€â”€ dto/                 # Data Transfer Objects
â”‚   â””â”€â”€ repository/
â”‚       â”œâ”€â”€ AuthRepository.kt
â”‚       â”œâ”€â”€ CartFirebaseRepository.kt
â”‚       â”œâ”€â”€ OrderFirebaseRepository.kt
â”‚       â””â”€â”€ UserFirebaseRepository.kt
â”‚
â”œâ”€â”€ model/                       # ğŸ·ï¸ Domain models
â”‚   â”œâ”€â”€ User.kt
â”‚   â”œâ”€â”€ Shop.kt
â”‚   â”œâ”€â”€ Product.kt
â”‚   â”œâ”€â”€ Order.kt
â”‚   â””â”€â”€ CartItem.kt
â”‚
â”œâ”€â”€ pages/                       # ğŸ“± CÃ¡c mÃ n hÃ¬nh chá»©c nÄƒng
â”‚   â”œâ”€â”€ customer/
â”‚   â”‚   â”œâ”€â”€ home/
â”‚   â”‚   â”œâ”€â”€ shop_detail/
â”‚   â”‚   â”œâ”€â”€ cart/
â”‚   â”‚   â””â”€â”€ order_tracking/
â”‚   â”œâ”€â”€ owner/
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â””â”€â”€ orders/
â”‚   â””â”€â”€ shipper/
â”‚       â”œâ”€â”€ deliveries/
â”‚       â””â”€â”€ gps/
â”‚
â”œâ”€â”€ navigation/                  # ğŸ§­ Äiá»u hÆ°á»›ng
â”‚   â”œâ”€â”€ AppNavigation.kt
â”‚   â””â”€â”€ Screen.kt                # Route definitions
â”‚
â”œâ”€â”€ ui/                          # ğŸ¨ UI components
â”‚   â””â”€â”€ theme/
â”‚       â”œâ”€â”€ Color.kt
â”‚       â”œâ”€â”€ Theme.kt
â”‚       â””â”€â”€ Type.kt
â”‚
â””â”€â”€ utils/                       # ğŸ”§ Utilities
    â”œâ”€â”€ LocationHelper.kt
    â””â”€â”€ Constants.kt
```

### 2.3 TrÃ¡ch nhiá»‡m tá»«ng táº§ng

| Táº§ng (Layer) | TrÃ¡ch nhiá»‡m | Lá»›p chÃ­nh |
|-------|---------------|-------------|
| **UI** | Display data, handle user input | `*Screen.kt` Compose functions |
| **ViewModel** | Hold UI state, business logic | `*ViewModel.kt`, `StateFlow` |
| **Repository** | Abstract data sources | `*Repository.kt` |
| **Data** | Network calls, local cache | `ApiClient`, Firebase SDK |
| **Model** | Domain entities | `User`, `Shop`, `Order` |

### 2.4 State Management

```kotlin
// Reference: LoginViewModel.kt
sealed class LogInState {
    object Idle : LogInState()
    object Loading : LogInState()
    data class Success(val user: User) : LogInState()
    data class Error(val message: String) : LogInState()
}

class LoginViewModel : ViewModel() {
    private val _logInState = MutableStateFlow<LogInState>(LogInState.Idle)
    val logInState: StateFlow<LogInState> = _logInState.asStateFlow()
    
    fun login(email: String, password: String) {
        viewModelScope.launch {
            _logInState.value = LogInState.Loading
            val result = authRepository.login(email, password)
            _logInState.value = when (result) {
                is ApiResult.Success -> LogInState.Success(result.data)
                is ApiResult.Error -> LogInState.Error(result.message)
            }
        }
    }
}
```

**Sá»­ dá»¥ng trong UI:**
```kotlin
// Reference: LoginScreen.kt
@Composable
fun LoginScreen(viewModel: LoginViewModel) {
    val state by viewModel.logInState.collectAsState()
    
    when (state) {
        is LogInState.Idle -> { /* Hiá»ƒn thá»‹ form Ä‘Äƒng nháº­p */ }
        is LogInState.Loading -> { CircularProgressIndicator() }
        is LogInState.Success -> { /* Äiá»u hÆ°á»›ng vá» trang chá»§ */ }
        is LogInState.Error -> { /* Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i */ }
    }
}
```

---

## 3. KIáº¾N TRÃšC BACKEND

### 3.1 Cáº¥u trÃºc module NestJS

```
Backend/functions/src/
â”‚
â”œâ”€â”€ index.ts                     # â˜ï¸ Äiá»ƒm vÃ o Cloud Functions
â”‚
â”œâ”€â”€ modules/                     # ğŸ“¦ CÃ¡c module chá»©c nÄƒng (23 tá»•ng cá»™ng)
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/                    # ğŸ” XÃ¡c thá»±c
â”‚   â”‚   â”œâ”€â”€ auth.module.ts       # Äá»‹nh nghÄ©a module
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts   # HTTP routes
â”‚   â”‚   â”œâ”€â”€ auth.service.ts      # Logic nghiá»‡p vá»¥
â”‚   â”‚   â””â”€â”€ dto/                 # Validation DTOs
â”‚   â”‚       â”œâ”€â”€ login.dto.ts
â”‚   â”‚       â””â”€â”€ register.dto.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ users/                   # ğŸ‘¤ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
â”‚   â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”‚   â””â”€â”€ users.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ shops/                   # ğŸª Quáº£n lÃ½ cá»­a hÃ ng
â”‚   â”‚   â”œâ”€â”€ shops.module.ts
â”‚   â”‚   â”œâ”€â”€ shops.controller.ts
â”‚   â”‚   â””â”€â”€ shops.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ products/                # ğŸ” Danh má»¥c sáº£n pháº©m
â”‚   â”‚   â”œâ”€â”€ products.module.ts
â”‚   â”‚   â”œâ”€â”€ products.controller.ts
â”‚   â”‚   â””â”€â”€ products.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ orders/                  # ğŸ“‹ Xá»­ lÃ½ Ä‘Æ¡n hÃ ng
â”‚   â”‚   â”œâ”€â”€ orders.module.ts
â”‚   â”‚   â”œâ”€â”€ orders.controller.ts
â”‚   â”‚   â””â”€â”€ orders.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ gps/                     # ğŸ“ Theo dÃµi GPS
â”‚   â”‚   â”œâ”€â”€ gps.module.ts
â”‚   â”‚   â”œâ”€â”€ gps.controller.ts
â”‚   â”‚   â””â”€â”€ gps.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ notifications/           # ğŸ”” ThÃ´ng bÃ¡o Ä‘áº©y
â”‚   â”‚   â”œâ”€â”€ notifications.module.ts
â”‚   â”‚   â”œâ”€â”€ notifications.controller.ts
â”‚   â”‚   â””â”€â”€ notifications.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ wallet/                  # ğŸ’° VÃ­/thanh toÃ¡n
â”‚   â”‚   â”œâ”€â”€ wallet.module.ts
â”‚   â”‚   â”œâ”€â”€ wallet.controller.ts
â”‚   â”‚   â””â”€â”€ wallet.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ vouchers/                # ğŸŸï¸ Há»‡ thá»‘ng voucher
â”‚   â”‚   â”œâ”€â”€ vouchers.module.ts
â”‚   â”‚   â”œâ”€â”€ vouchers.controller.ts
â”‚   â”‚   â””â”€â”€ vouchers.service.ts
â”‚   â”‚
â”‚   â””â”€â”€ ...                      # 14 module khÃ¡c
â”‚
â””â”€â”€ shared/                      # ğŸ”§ Tiá»‡n Ã­ch dÃ¹ng chung
    â”œâ”€â”€ guards/
    â”‚   â”œâ”€â”€ auth.guard.ts        # XÃ¡c thá»±c token
    â”‚   â””â”€â”€ roles.guard.ts       # Kiá»ƒm soÃ¡t truy cáº­p theo vai trÃ²
    â”œâ”€â”€ decorators/
    â”‚   â””â”€â”€ roles.decorator.ts   # @Roles() decorator
    â””â”€â”€ services/
        â”œâ”€â”€ firebase.service.ts  # Firebase Admin SDK
        â””â”€â”€ storage.service.ts   # Cloud Storage
```

### 3.2 Luá»“ng xá»­ lÃ½ Request

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LUá»’NG Xá»¬ LÃ REQUEST                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚   [Android App]                                                           â”‚
â”‚        â”‚                                                                  â”‚
â”‚        â”‚ HTTP Request + Firebase ID Token                                 â”‚
â”‚        â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                   Cloud Functions                               â”‚    â”‚
â”‚   â”‚                                                                  â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚   â”‚                    NestJS App                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                                                           â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                  MIDDLEWARE                          â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ Logging                                           â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ CORS                                              â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ PhÃ¢n tÃ­ch body request                            â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â”‚                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â–¼                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚               AUTH GUARD (@UseGuards)               â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                                                      â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  1. Láº¥y Bearer token tá»« header                       â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  2. XÃ¡c thá»±c token vá»›i Firebase Admin SDK            â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  3. Láº¥y thÃ´ng tin user tá»« Firestore                  â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  4. Gáº¯n user vÃ o request object                      â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â”‚                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â–¼                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚              ROLES GUARD (@Roles)                    â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                                                      â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ Kiá»ƒm tra user.role vá»›i cÃ¡c vai trÃ² Ä‘Æ°á»£c yÃªu cáº§u   â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ @Roles(UserRole.CUSTOMER, UserRole.ADMIN)        â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â”‚                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â–¼                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                   CONTROLLER                         â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                                                      â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  @Post('/orders')                                    â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  createOrder(@Body() dto, @Request() req) {          â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚    return this.ordersService.create(req.user, dto);  â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  }                                                   â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â”‚                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â–¼                             â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                    SERVICE                           â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚                                                      â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ Logic nghiá»‡p vá»¥                                   â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ Thao tÃ¡c Firestore                                â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â”‚  â€¢ Gá»i service khÃ¡c                                  â”‚ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚   â”‚   â”‚                             â”‚                             â”‚ â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â”‚                                 â”‚                                â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                      â”‚
â”‚                                     â–¼                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                     FIRESTORE DATABASE                          â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Máº«u API Module

```typescript
// â”€â”€â”€ MODULE (auth.module.ts) â”€â”€â”€
@Module({
  imports: [UsersModule],
  controllers: [AuthController],
  providers: [AuthService],
  exports: [AuthService],
})
export class AuthModule {}

// â”€â”€â”€ CONTROLLER (auth.controller.ts) â”€â”€â”€
@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('login')
  async login(@Body() dto: LoginDto) {
    return this.authService.login(dto.email, dto.password);
  }

  @Post('register')
  async register(@Body() dto: RegisterDto) {
    return this.authService.register(dto);
  }
}

// â”€â”€â”€ SERVICE (auth.service.ts) â”€â”€â”€
@Injectable()
export class AuthService {
  constructor(
    private readonly usersService: UsersService,
    private readonly firebaseService: FirebaseService,
  ) {}

  async login(email: string, password: string) {
    // 1. XÃ¡c thá»±c thÃ´ng tin Ä‘Äƒng nháº­p vá»›i Firebase Auth
    // 2. Láº¥y dá»¯ liá»‡u user tá»« Firestore
    // 3. Táº¡o custom token
    // 4. Tráº£ vá» user + token
  }
}
```

**Tham kháº£o:** `Backend/functions/src/modules/auth/`

---

## 4. KIáº¾N TRÃšC Dá»® LIá»†U

### 4.1 CÃ¡c Collection Firestore

```
firestore/
â”‚
â”œâ”€â”€ users/                       # ğŸ‘¤ TÃ i khoáº£n ngÆ°á»i dÃ¹ng
â”‚   â””â”€â”€ {userId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ email: string
â”‚       â”œâ”€â”€ role: "CUSTOMER" | "OWNER" | "SHIPPER" | "ADMIN"
â”‚       â”œâ”€â”€ status: "ACTIVE" | "INACTIVE" | "PENDING"
â”‚       â”œâ”€â”€ createdAt: timestamp
â”‚       â””â”€â”€ fcmTokens/           # ğŸ“± Token thÃ´ng bÃ¡o Ä‘áº©y
â”‚           â””â”€â”€ {tokenId}/
â”‚               â””â”€â”€ token: string
â”‚
â”œâ”€â”€ shops/                       # ğŸª Cá»­a hÃ ng
â”‚   â””â”€â”€ {shopId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ ownerId: string
â”‚       â”œâ”€â”€ name: string
â”‚       â”œâ”€â”€ status: "PENDING" | "APPROVED" | "REJECTED"
â”‚       â”œâ”€â”€ location: geopoint
â”‚       â””â”€â”€ createdAt: timestamp
â”‚
â”œâ”€â”€ products/                    # ğŸ” Danh má»¥c sáº£n pháº©m
â”‚   â””â”€â”€ {productId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ shopId: string
â”‚       â”œâ”€â”€ name: string
â”‚       â”œâ”€â”€ price: number
â”‚       â”œâ”€â”€ soldCount: number
â”‚       â”œâ”€â”€ isAvailable: boolean
â”‚       â””â”€â”€ createdAt: timestamp
â”‚
â”œâ”€â”€ orders/                      # ğŸ“‹ ÄÆ¡n hÃ ng
â”‚   â””â”€â”€ {orderId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ customerId: string
â”‚       â”œâ”€â”€ shopId: string
â”‚       â”œâ”€â”€ shipperId: string | null
â”‚       â”œâ”€â”€ status: "PENDING" | "CONFIRMED" | "PREPARING" | ...
â”‚       â”œâ”€â”€ items: CartItem[]
â”‚       â”œâ”€â”€ totalAmount: number
â”‚       â””â”€â”€ createdAt: timestamp
â”‚
â”œâ”€â”€ trips/                       # ğŸšš Chuyáº¿n giao hÃ ng (GPS)
â”‚   â””â”€â”€ {tripId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ shipperId: string
â”‚       â”œâ”€â”€ orderIds: string[]
â”‚       â”œâ”€â”€ status: "PENDING" | "IN_PROGRESS" | "COMPLETED"
â”‚       â”œâ”€â”€ routePolyline: string
â”‚       â””â”€â”€ currentLocation: geopoint
â”‚
â”œâ”€â”€ wallets/                     # ğŸ’° VÃ­ ngÆ°á»i dÃ¹ng
â”‚   â””â”€â”€ {userId}/
â”‚       â”œâ”€â”€ balance: number
â”‚       â””â”€â”€ transactions/
â”‚           â””â”€â”€ {transactionId}/
â”‚
â”œâ”€â”€ vouchers/                    # ğŸŸï¸ Voucher giáº£m giÃ¡
â”‚   â””â”€â”€ {voucherId}/
â”‚       â”œâ”€â”€ code: string
â”‚       â”œâ”€â”€ discountPercent: number
â”‚       â”œâ”€â”€ expiresAt: timestamp
â”‚       â””â”€â”€ usedBy: string[]
â”‚
â””â”€â”€ notifications/               # ğŸ”” Lá»‹ch sá»­ thÃ´ng bÃ¡o
    â””â”€â”€ {notificationId}/
        â”œâ”€â”€ userId: string
        â”œâ”€â”€ title: string
        â”œâ”€â”€ body: string
        â”œâ”€â”€ isRead: boolean
        â””â”€â”€ createdAt: timestamp
```

### 4.2 VÃ­ dá»¥ Data Flow

#### 4.2.1 Luá»“ng Ä‘Äƒng nháº­p ngÆ°á»i dÃ¹ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LUá»’NG ÄÄ‚NG NHáº¬P NGÆ¯á»œI DÃ™NG                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [LoginScreen]                                                   â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 1. NgÆ°á»i dÃ¹ng nháº­p email/password                       â”‚
â”‚       â”‚ 2. Nháº¥n nÃºt "Login"                                     â”‚
â”‚       â–¼                                                          â”‚
â”‚  [LoginViewModel]                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 3. _logInState = Loading                                 â”‚
â”‚       â”‚ 4. authRepository.login(email, password)                 â”‚
â”‚       â–¼                                                          â”‚
â”‚  [AuthRepository]                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 5. apiService.login(LoginRequest)                        â”‚
â”‚       â–¼                                                          â”‚
â”‚  [API: POST /auth/login]  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚
â”‚       â”‚                                         [Backend]        â”‚
â”‚       â”‚                                              â”‚           â”‚
â”‚       â”‚                   6. XÃ¡c thá»±c vá»›i Firebase Auth          â”‚
â”‚       â”‚                   7. Láº¥y user tá»« Firestore               â”‚
â”‚       â”‚                   8. Táº¡o custom token                       â”‚
â”‚       â”‚                                              â”‚           â”‚
â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚  { customToken, user }                                   â”‚
â”‚       â–¼                                                          â”‚
â”‚  [AuthRepository]                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 9. FirebaseAuth.signInWithCustomToken()                  â”‚
â”‚       â”‚ 10. LÆ°u user vÃ o state cá»¥c bá»™                           â”‚
â”‚       â–¼                                                          â”‚
â”‚  [LoginViewModel]                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 11. _logInState = Success(user)                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  [LoginScreen]                                                   â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ 12. Äiá»u hÆ°á»›ng vá» HomeScreen                         â”‚
â”‚       â–¼                                                          â”‚
â”‚  [HomeScreen]                                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 Luá»“ng táº¡o Ä‘Æ¡n hÃ ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LUá»’NG Táº O ÄÆ N HÃ€NG                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [CartScreen] â”€â–º [CheckoutScreen]                               â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ 1. NgÆ°á»i dÃ¹ng xÃ¡c nháº­n Ä‘Æ¡n              â”‚
â”‚                        â–¼                                         â”‚
â”‚                   [CartViewModel]                                â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ 2. orderRepository.createOrder()        â”‚
â”‚                        â–¼                                         â”‚
â”‚  [API: POST /orders]  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º       â”‚
â”‚                                               [Backend]          â”‚
â”‚                                                    â”‚             â”‚
â”‚                      3. Kiá»ƒm tra cart items          â”‚             â”‚
â”‚                      4. TÃ­nh tá»•ng tiá»n + phÃ­         â”‚             â”‚
â”‚                      5. Ãp dá»¥ng voucher (náº¿u cÃ³)     â”‚             â”‚
â”‚                      6. Trá»« sá»‘ dÆ° vÃ­              â”‚             â”‚
â”‚                      7. Táº¡o order document        â”‚             â”‚
â”‚                      8. Gá»­i thÃ´ng bÃ¡o cho shop  â”‚             â”‚
â”‚                                                    â”‚             â”‚
â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ { orderId, status: "PENDING" }          â”‚
â”‚                        â–¼                                         â”‚
â”‚                   [CartViewModel]                                â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ 9. Äiá»u hÆ°á»›ng Ä‘áº¿n OrderTrackingScreen  â”‚
â”‚                        â–¼                                         â”‚
â”‚              [OrderTrackingScreen]                               â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ 10. Láº¯ng nghe cáº­p nháº­t order status â”‚
â”‚                        â”‚     (Firestore real-time listener)      â”‚
â”‚                        â–¼                                         â”‚
â”‚              [Cáº­p nháº­t theo thá»i gian thá»±c: CONFIRMED â†’ ...]    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. SECURITY ARCHITECTURE

### 5.1 Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AUTHENTICATION LAYERS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Layer 1: Firebase Authentication                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  â€¢ Email/Password login                                          â”‚
â”‚  â€¢ Google Sign-In                                                â”‚
â”‚  â€¢ Firebase ID Token (JWT)                                       â”‚
â”‚                                                                  â”‚
â”‚  Layer 2: Backend Token Validation (AuthGuard)                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ Verify Firebase ID Token with Admin SDK                       â”‚
â”‚  â€¢ Fetch user document from Firestore                            â”‚
â”‚  â€¢ Attach user to request context                                â”‚
â”‚                                                                  â”‚
â”‚  Layer 3: Role-Based Access Control (RolesGuard)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ Check user.role against required roles                        â”‚
â”‚  â€¢ @Roles(UserRole.CUSTOMER, UserRole.ADMIN)                    â”‚
â”‚                                                                  â”‚
â”‚  Layer 4: Firestore Security Rules                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  â€¢ Document-level access control                                 â”‚
â”‚  â€¢ Owner-only update/delete                                      â”‚
â”‚  â€¢ Role-based read/write permissions                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Firestore Security Rules

```javascript
// Reference: Backend/firestore.rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // â”€â”€â”€ HÃ€M Há»– TRá»¢ â”€â”€â”€
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isCurrentUser(userId) {
      return request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isAdmin() {
      return hasRole('ADMIN');
    }
    
    function isOwner() {
      return hasRole('OWNER');
    }
    
    function isShipper() {
      return hasRole('SHIPPER');
    }
    
    // â”€â”€â”€ USERS COLLECTION â”€â”€â”€
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isCurrentUser(userId);
      allow update: if isCurrentUser(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // â”€â”€â”€ SHOPS COLLECTION â”€â”€â”€
    match /shops/{shopId} {
      allow read: if true;  // Äá»c cÃ´ng khai Ä‘á»ƒ duyá»‡t
      allow create: if isAuthenticated();
      allow update, delete: if resource.data.ownerId == request.auth.uid || isAdmin();
    }
    
    // â”€â”€â”€ PRODUCTS COLLECTION â”€â”€â”€
    match /products/{productId} {
      allow read: if true;  // Äá»c cÃ´ng khai Ä‘á»ƒ duyá»‡t
      allow create: if isOwner() || isAdmin();
      allow update, delete: if isOwner() || isAdmin();
    }
    
    // â”€â”€â”€ ORDERS COLLECTION â”€â”€â”€
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.shipperId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // â”€â”€â”€ Máº¶C Äá»ŠNH Tá»ª CHá»I â”€â”€â”€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### 5.3 Äá»‹nh nghÄ©a vai trÃ²

| Vai trÃ² | Quyá»n háº¡n | TrÆ°á»ng há»£p sá»­ dá»¥ng |
|------|-------------|----------|
| **CUSTOMER** | Duyá»‡t cá»­a hÃ ng, Ä‘áº·t hÃ ng, theo dÃµi Ä‘Æ¡n | NgÆ°á»i dÃ¹ng cuá»‘i |
| **OWNER** | Quáº£n lÃ½ cá»­a hÃ ng, sáº£n pháº©m, xem Ä‘Æ¡n | Chá»§ cá»­a hÃ ng |
| **SHIPPER** | Nháº­n Ä‘Æ¡n giao, GPS tracking, hoÃ n táº¥t Ä‘Æ¡n | TÃ i xáº¿ giao hÃ ng |
| **ADMIN** | Truy cáº­p toÃ n bá»™, duyá»‡t cá»­a hÃ ng, quáº£n lÃ½ user | Quáº£n trá»‹ viÃªn há»‡ thá»‘ng |

---

## 6. NAVIGATION ARCHITECTURE

### 6.1 Android Navigation Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NAVIGATION GRAPH                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [App Start]                                                     â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚   Splash    â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚         â”‚                                                        â”‚
â”‚         â”œâ”€â”€â”€ User logged in? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚                                     â”‚                  â”‚
â”‚         â–¼ No                                  â–¼ Yes              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Login     â”‚                       â”‚    Home     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚  (by role)  â”‚           â”‚
â”‚         â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                                     â”‚                  â”‚
â”‚         â”œâ”€â–º SignUp                            â”œâ”€â–º CUSTOMER       â”‚
â”‚         â”‚                                     â”‚   â”œâ”€â–º ShopList   â”‚
â”‚         â””â”€â–º ForgotPassword                    â”‚   â”œâ”€â–º ShopDetail â”‚
â”‚                                               â”‚   â”œâ”€â–º Cart       â”‚
â”‚                                               â”‚   â”œâ”€â–º Checkout   â”‚
â”‚                                               â”‚   â”œâ”€â–º Orders     â”‚
â”‚                                               â”‚   â”œâ”€â–º OrderTrack â”‚
â”‚                                               â”‚   â”œâ”€â–º Profile    â”‚
â”‚                                               â”‚   â””â”€â–º Wallet     â”‚
â”‚                                               â”‚                  â”‚
â”‚                                               â”œâ”€â–º OWNER          â”‚
â”‚                                               â”‚   â”œâ”€â–º Dashboard  â”‚
â”‚                                               â”‚   â”œâ”€â–º Products   â”‚
â”‚                                               â”‚   â”œâ”€â–º Orders     â”‚
â”‚                                               â”‚   â””â”€â–º Profile    â”‚
â”‚                                               â”‚                  â”‚
â”‚                                               â””â”€â–º SHIPPER        â”‚
â”‚                                                   â”œâ”€â–º Deliveries â”‚
â”‚                                                   â”œâ”€â–º GPS Map    â”‚
â”‚                                                   â””â”€â–º Profile    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Navigation Implementation

```kotlin
// Reference: navigation/AppNavigation.kt
@Composable
fun AppNavigation(navController: NavHostController) {
    NavHost(navController = navController, startDestination = Screen.Splash.route) {
        composable(Screen.Splash.route) { SplashScreen(navController) }
        composable(Screen.Login.route) { LoginScreen(navController) }
        composable(Screen.SignUp.route) { SignUpScreen(navController) }
        composable(Screen.Home.route) { HomeScreen(navController) }
        composable(Screen.ShopDetail.route + "/{shopId}") { backStackEntry ->
            ShopDetailScreen(
                navController = navController,
                shopId = backStackEntry.arguments?.getString("shopId") ?: ""
            )
        }
        // ... nhiá»u route khÃ¡c
    }
}

// Reference: navigation/Screen.kt
sealed class Screen(val route: String) {
    object Splash : Screen("splash")
    object Login : Screen("login")
    object SignUp : Screen("signup")
    object Home : Screen("home")
    object ShopDetail : Screen("shop_detail")
    object Cart : Screen("cart")
    object OrderTracking : Screen("order_tracking")
    // ...
}
```

---

## 7. CÃC QUYáº¾T Äá»ŠNH KIáº¾N TRÃšC CHÃNH

### 7.1 TÃ³m táº¯t cÃ¡c quyáº¿t Ä‘á»‹nh

| Quyáº¿t Ä‘á»‹nh | Lá»±a chá»n | LÃ½ do |
|----------|--------|-----------|
| **UI Framework** | Jetpack Compose | Modern, declarative, Google-backed |
| **Architecture** | MVVM | Compose integration, lifecycle-aware |
| **State** | StateFlow | Native Kotlin, structured concurrency |
| **Backend** | NestJS on Cloud Functions | TypeScript, modular, scalable |
| **Database** | Firestore | Real-time, offline, security rules |
| **Auth** | Firebase Auth | Managed, multi-provider, tokens |
| **DI (Android)** | Manual Factory | Simplicity over complexity |
| **DI (Backend)** | NestJS built-in | Native module injection |

### 7.2 Trade-offs Acknowledged

| Area | Trade-off | Mitigation |
|------|-----------|------------|
| **Manual DI** | More boilerplate | Clear factory pattern |
| **Firestore** | NoSQL limitations | Denormalization where needed |
| **Cloud Functions** | Cold starts | Keep functions warm, 2GB memory |
| **Single codebase** | Android-only | Future: Flutter or React Native |

---

## 8. THAM CHIáº¾U FILE

| ThÃ nh pháº§n | CÃ¡c file chÃ­nh |
|-----------|-----------|
| **Android Architecture** | `FoodApp/ARCHITECTURE.md` |
| **Navigation** | `navigation/AppNavigation.kt`, `Screen.kt` |
| **ViewModels** | `authentication/**/`, `pages/**/` |
| **Repositories** | `data/repository/` |
| **Backend Modules** | `Backend/functions/src/modules/` |
| **Security Rules** | `Backend/firestore.rules` |
| **API Entry** | `Backend/functions/src/index.ts` |

---

**END OF ARCHITECTURE**
