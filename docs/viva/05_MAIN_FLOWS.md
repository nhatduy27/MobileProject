# ğŸ”„ LUá»’NG Xá»¬ LÃ CHÃNH - á»¨ng dá»¥ng KTX Delivery
> **TÃ i liá»‡u Viva - Giai Ä‘oáº¡n 2**  
> **Cáº­p nháº­t láº§n cuá»‘i:** 30 thÃ¡ng 1, 2026

---

## Má»¤C Lá»¤C

1. [Luá»“ng XÃ¡c Thá»±c](#1-authentication-flow)
2. [Luá»“ng Duyá»‡t QuÃ¡n/Menu](#2-browse-restaurantsmenu-flow)
3. [Luá»“ng Giá» HÃ ng â†’ Thanh ToÃ¡n â†’ Äáº·t HÃ ng](#3-cart--checkout--place-order-flow)
4. [Luá»“ng NgÆ°á»i BÃ¡n XÃ¡c Nháº­n & Chuáº©n Bá»‹](#4-seller-confirms--prepares-flow)
5. [Luá»“ng Shipper Nháº­n & Giao HÃ ng](#5-shipper-picks-up--delivers-flow)
6. [Luá»“ng ThÃ´ng BÃ¡o](#6-notification-flow)
7. [Luá»“ng Chat](#7-chat-flow)
8. [Luá»“ng Theo DÃµi GPS](#8-gps-tracking-flow)
9. [Háº¡n Cháº¿ ÄÃ£ Biáº¿t](#9-known-limitations)

---

## 1. LUá»’NG XÃC THá»°C (AUTHENTICATION FLOW)

### 1.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AUTHENTICATION FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [User Opens App]                                                            â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚   â”‚   Splash    â”‚                                                            â”‚
â”‚   â”‚   Screen    â”‚                                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â”‚ Check AuthManager.getValidToken()                                  â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â”œâ”€â”€â”€â”€ Token exists? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚          â”‚                                            â”‚                      â”‚
â”‚          â–¼ No                                         â–¼ Yes                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚   Login     â”‚                              â”‚  Role-based â”‚               â”‚
â”‚   â”‚   Screen    â”‚                              â”‚    Home     â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â”œâ”€â”€â”€â”€ Email/Password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚          â”‚                                           â”‚                       â”‚
â”‚          â”œâ”€â”€â”€â”€ Google Sign-In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â”‚                                           â”‚      â”‚                â”‚
â”‚          â”‚                                           â–¼      â–¼                â”‚
â”‚          â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚          â”‚                                    â”‚  POST /auth/    â”‚            â”‚
â”‚          â”‚                                    â”‚  login OR       â”‚            â”‚
â”‚          â”‚                                    â”‚  google-login   â”‚            â”‚
â”‚          â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                     â”‚
â”‚          â”‚                                             â–¼                     â”‚
â”‚          â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚          â”‚                                    â”‚ Firebase Auth   â”‚            â”‚
â”‚          â”‚                                    â”‚ Verify + Create â”‚            â”‚
â”‚          â”‚                                    â”‚ Custom Token    â”‚            â”‚
â”‚          â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                     â”‚
â”‚          â”‚                                             â–¼                     â”‚
â”‚          â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚          â”‚                                    â”‚ Return token +  â”‚            â”‚
â”‚          â”‚                                    â”‚ user data       â”‚            â”‚
â”‚          â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                     â”‚
â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚   â”‚ Firebase    â”‚ signInWithCustomToken()                                    â”‚
â”‚   â”‚ Sign-In     â”‚                                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚   â”‚ Register    â”‚ FirebaseMessaging.getToken()                               â”‚
â”‚   â”‚ FCM Token   â”‚ â†’ POST /users/fcm-token                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â”‚ Check user.role                                                    â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â”œâ”€â”€â”€â”€ CUSTOMER â”€â”€â–º UserHomeScreen                                   â”‚
â”‚          â”œâ”€â”€â”€â”€ OWNER â”€â”€â”€â”€â”€â–º DashBoardRootScreen                              â”‚
â”‚          â””â”€â”€â”€â”€ SHIPPER â”€â”€â”€â–º ShipperDashboardRootScreen                       â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | NgÆ°á»i dÃ¹ng (má»i vai trÃ²) |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | ÄÃ£ cÃ i Ä‘áº·t á»©ng dá»¥ng, cÃ³ káº¿t ná»‘i internet |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | NgÆ°á»i dÃ¹ng má»Ÿ á»©ng dá»¥ng hoáº·c nháº¥n ÄÄƒng nháº­p |

### 1.3 CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n

| # | TÃ¡c nhÃ¢n | HÃ nh Ä‘á»™ng | Pháº£n há»“i há»‡ thá»‘ng |
|---|----------|-----------|-------------------|
| 1 | NgÆ°á»i dÃ¹ng | Má»Ÿ á»©ng dá»¥ng | Hiá»ƒn thá»‹ mÃ n hÃ¬nh Splash |
| 2 | Há»‡ thá»‘ng | Kiá»ƒm tra token Ä‘Ã£ lÆ°u | Náº¿u há»£p lá»‡ â†’ Ä‘iá»u hÆ°á»›ng vá» trang chá»§; náº¿u khÃ´ng â†’ hiá»ƒn thá»‹ ÄÄƒng nháº­p |
| 3 | NgÆ°á»i dÃ¹ng | Nháº­p email/máº­t kháº©u HOáº¶C nháº¥n Google Sign-In | XÃ¡c thá»±c Ä‘áº§u vÃ o |
| 4 | Há»‡ thá»‘ng | Gá»i `POST /api/auth/login` hoáº·c `POST /api/auth/google-login` | Backend xÃ¡c minh thÃ´ng tin |
| 5 | Backend | XÃ¡c minh vá»›i Firebase Auth REST API | Láº¥y báº£n ghi ngÆ°á»i dÃ¹ng |
| 6 | Backend | Truy váº¥n ngÆ°á»i dÃ¹ng tá»« collection `users` | Láº¥y role, status |
| 7 | Backend | Táº¡o Firebase custom token | Tráº£ vá» `{ customToken, user }` |
| 8 | Android | Gá»i `FirebaseAuth.signInWithCustomToken()` | Nháº­n Firebase ID token |
| 9 | Android | LÆ°u token vÃ o `AuthManager` | LÆ°u vÃ o SharedPreferences |
| 10 | Android | ÄÄƒng kÃ½ FCM token qua `POST /api/users/fcm-token` | LÆ°u vÃ o `users/{id}/fcmTokens` |
| 11 | Android | Äiá»u hÆ°á»›ng dá»±a trÃªn `user.role` | Hiá»ƒn thá»‹ mÃ n hÃ¬nh trang chá»§ theo vai trÃ² |

### 1.4 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `users` | Äá»c | `id`, `email`, `role`, `status` |
| `users/{id}/fcmTokens` | Táº¡o | `token`, `createdAt` |

### 1.5 ThÃ´ng BÃ¡o ÄÆ°á»£c KÃ­ch Hoáº¡t

KhÃ´ng cÃ³ (xÃ¡c thá»±c khÃ´ng kÃ­ch hoáº¡t thÃ´ng bÃ¡o Ä‘áº©y)

### 1.6 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh ÄÄƒng nháº­p | `authentication/login/LoginScreen.kt` |
| Login ViewModel | `authentication/login/LoginViewModel.kt` |
| Auth Repository | `data/repository/shared/AuthRepository.kt` |
| Auth Manager | `data/repository/firebase/AuthManager.kt` |
| Backend Auth Service | `modules/auth/auth.service.ts` |

---

## 2. LUá»’NG DUYá»†T QUÃN/MENU (BROWSE RESTAURANTS/MENU FLOW)

### 2.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BROWSE RESTAURANTS/MENU FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Customer Home Screen]                                                      â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”œâ”€â”€â”€â”€ View All Shops â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚                                              â”‚                     â”‚
â”‚         â”œâ”€â”€â”€â”€ Search Products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                                              â”‚      â”‚              â”‚
â”‚         â–¼                                              â–¼      â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ GET /shops  â”‚                              â”‚ GET /products   â”‚           â”‚
â”‚   â”‚             â”‚                              â”‚ ?search=xxx     â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                                              â”‚                    â”‚
â”‚          â”‚ Display shop cards                           â”‚ Display results    â”‚
â”‚          â”‚                                              â”‚                    â”‚
â”‚          â–¼                                              â”‚                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚                    â”‚
â”‚   â”‚ Tap Shop    â”‚                                       â”‚                    â”‚
â”‚   â”‚ Card        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                    â”‚
â”‚          â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚           SHOP DETAIL SCREEN            â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Shop Info: name, rating, address       â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                                â”‚
â”‚   â”‚   â”‚        PRODUCT LIST            â”‚    â”‚                                â”‚
â”‚   â”‚   â”‚  GET /products?shopId=xxx      â”‚    â”‚                                â”‚
â”‚   â”‚   â”‚                                 â”‚    â”‚                                â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚                                â”‚
â”‚   â”‚   â”‚  â”‚Product 1â”‚ â”‚Product 2â”‚ ...  â”‚    â”‚                                â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚                                â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚               â”‚                                                               â”‚
â”‚               â”‚ Tap product                                                   â”‚
â”‚               â–¼                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚         PRODUCT DETAIL SCREEN           â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Name, price, description, images       â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Select quantity]  [Add to Cart]       â”‚                                â”‚
â”‚   â”‚                           â”‚              â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                               â”‚                                               â”‚
â”‚                               â–¼                                               â”‚
â”‚                     POST /cart (add item)                                     â”‚
â”‚                               â”‚                                               â”‚
â”‚                               â–¼                                               â”‚
â”‚                     Navigate to Cart or continue browsing                     â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | KhÃ¡ch hÃ ng (BUYER) |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p vá»›i vai trÃ² CUSTOMER |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | NgÆ°á»i dÃ¹ng má»Ÿ trang chá»§ hoáº·c tÃ¬m kiáº¿m |

### 2.3 CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n

| # | TÃ¡c nhÃ¢n | HÃ nh Ä‘á»™ng | Pháº£n há»“i há»‡ thá»‘ng |
|---|----------|-----------|-------------------|
| 1 | KhÃ¡ch hÃ ng | Má»Ÿ mÃ n hÃ¬nh trang chá»§ | Táº£i cÃ¡c quÃ¡n ná»•i báº­t vÃ  sáº£n pháº©m |
| 2 | Há»‡ thá»‘ng | Gá»i `GET /api/shops` | Tráº£ vá» danh sÃ¡ch quÃ¡n |
| 3 | Há»‡ thá»‘ng | Gá»i `GET /api/products` | Tráº£ vá» cÃ¡c sáº£n pháº©m ná»•i báº­t |
| 4 | KhÃ¡ch hÃ ng | Nháº¥n tháº» quÃ¡n | Äiá»u hÆ°á»›ng Ä‘áº¿n ShopDetailScreen |
| 5 | Há»‡ thá»‘ng | Gá»i `GET /api/products?shopId=xxx` | Tráº£ vá» sáº£n pháº©m cá»§a quÃ¡n |
| 6 | KhÃ¡ch hÃ ng | Nháº¥n sáº£n pháº©m | Äiá»u hÆ°á»›ng Ä‘áº¿n ProductDetailScreen |
| 7 | KhÃ¡ch hÃ ng | Äáº·t sá»‘ lÆ°á»£ng, nháº¥n "ThÃªm vÃ o Giá»" | Gá»i `POST /api/cart` |
| 8 | Há»‡ thá»‘ng | ThÃªm sáº£n pháº©m vÃ o giá» | LÆ°u vÃ o `carts/{userId}/items` |

### 2.4 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `shops` | Äá»c | `id`, `name`, `imageUrl`, `rating`, `status`, `address` |
| `products` | Äá»c | `id`, `name`, `price`, `imageUrl`, `shopId`, `categoryId`, `isAvailable` |
| `categories` | Äá»c | `id`, `name` |
| `carts/{userId}/items` | Táº¡o/Cáº­p nháº­t | `productId`, `quantity`, `price`, `shopId` |

### 2.5 ThÃ´ng BÃ¡o ÄÆ°á»£c KÃ­ch Hoáº¡t

KhÃ´ng cÃ³

### 2.6 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh Trang chá»§ | `pages/client/home/UserHomeScreen.kt` |
| Home ViewModel | `pages/client/home/UserHomeViewModel.kt` |
| Chi Tiáº¿t QuÃ¡n | `pages/client/shop/ShopDetailScreen.kt` |
| Chi Tiáº¿t Sáº£n Pháº©m | `pages/client/productdetail/ProductDetailScreen.kt` |

---

## 3. LUá»’NG GIá» HÃ€NG â†’ THANH TOÃN â†’ Äáº¶T HÃ€NG (CART â†’ CHECKOUT â†’ PLACE ORDER FLOW)

### 3.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CART â†’ CHECKOUT â†’ PLACE ORDER FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Customer Cart Screen]                                                      â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ GET /cart (grouped by shop)                                         â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚           CART DISPLAY                   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Shop A:                                â”‚                                â”‚
â”‚   â”‚     - Product 1 x 2 = 50,000Ä‘           â”‚                                â”‚
â”‚   â”‚     - Product 2 x 1 = 30,000Ä‘           â”‚                                â”‚
â”‚   â”‚   Subtotal: 80,000Ä‘                      â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Shop B: (separate order)               â”‚                                â”‚
â”‚   â”‚     - Product 3 x 1 = 40,000Ä‘           â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Checkout Shop A]                      â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                  â”‚                                                            â”‚
â”‚                  â”‚ Tap "Checkout"                                             â”‚
â”‚                  â–¼                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚         PAYMENT SCREEN                   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Delivery Address: [Select/Edit]        â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Payment Method:                        â”‚                                â”‚
â”‚   â”‚     â—‹ Cash on Delivery (COD)             â”‚                                â”‚
â”‚   â”‚     â—‹ Bank Transfer (SePay QR)           â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Voucher: [Enter code] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º POST /vouchers/validate   â”‚
â”‚   â”‚                                          â”‚â—„â”€â”€â”€ { discount, valid }        â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚                                â”‚
â”‚   â”‚   Subtotal:        80,000Ä‘               â”‚                                â”‚
â”‚   â”‚   Shipping:             0Ä‘  (free)       â”‚                                â”‚
â”‚   â”‚   Voucher:        -10,000Ä‘               â”‚                                â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚                                â”‚
â”‚   â”‚   Total:           70,000Ä‘               â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Place Order] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º POST /orders              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                         â”‚
â”‚                                                     â”‚                         â”‚
â”‚                                                     â–¼                         â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                                    â”‚   BACKEND: OrdersService       â”‚        â”‚
â”‚                                    â”‚                                 â”‚        â”‚
â”‚                                    â”‚   TRANSACTION:                  â”‚        â”‚
â”‚                                    â”‚   1. Validate cart exists       â”‚        â”‚
â”‚                                    â”‚   2. Validate shop is OPEN      â”‚        â”‚
â”‚                                    â”‚   3. Apply voucher (atomic)     â”‚        â”‚
â”‚                                    â”‚   4. Create order document      â”‚        â”‚
â”‚                                    â”‚   5. Clear cart                 â”‚        â”‚
â”‚                                    â”‚   6. Send NEW_ORDER notif       â”‚        â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                   â”‚                          â”‚
â”‚                                                   â”‚ Return { orderId }       â”‚
â”‚                                                   â–¼                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚       ORDER SUCCESS SCREEN              â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   âœ… Order placed successfully!          â”‚                                â”‚
â”‚   â”‚   Order ID: ORD-260130-0001             â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Track Order] [Back to Home]           â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | KhÃ¡ch hÃ ng (BUYER) |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p, giá» hÃ ng cÃ³ sáº£n pháº©m, Ä‘Ã£ Ä‘áº·t Ä‘á»‹a chá»‰ giao hÃ ng |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | KhÃ¡ch hÃ ng nháº¥n "Thanh ToÃ¡n" trong giá» hÃ ng |

### 3.3 CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n

| # | TÃ¡c nhÃ¢n | HÃ nh Ä‘á»™ng | Pháº£n há»“i há»‡ thá»‘ng |
|---|----------|-----------|-------------------|
| 1 | KhÃ¡ch hÃ ng | Má»Ÿ mÃ n hÃ¬nh giá» hÃ ng | Táº£i giá» qua `GET /api/cart` |
| 2 | Há»‡ thá»‘ng | NhÃ³m sáº£n pháº©m theo quÃ¡n | Hiá»ƒn thá»‹ thanh toÃ¡n riÃªng cho má»—i nhÃ³m quÃ¡n |
| 3 | KhÃ¡ch hÃ ng | Nháº¥n "Thanh ToÃ¡n" cho má»™t nhÃ³m quÃ¡n | Äiá»u hÆ°á»›ng Ä‘áº¿n PaymentScreen |
| 4 | KhÃ¡ch hÃ ng | Chá»n/xÃ¡c nháº­n Ä‘á»‹a chá»‰ giao hÃ ng | XÃ¡c thá»±c Ä‘á»‹a chá»‰ tá»“n táº¡i |
| 5 | KhÃ¡ch hÃ ng | Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n | COD hoáº·c Chuyá»ƒn khoáº£n NgÃ¢n hÃ ng |
| 6 | KhÃ¡ch hÃ ng | (TÃ¹y chá»n) Nháº­p mÃ£ phiáº¿u giáº£m giÃ¡ | Gá»i `POST /api/vouchers/validate` |
| 7 | Há»‡ thá»‘ng | XÃ¡c thá»±c phiáº¿u | Tráº£ vá» sá»‘ tiá»n giáº£m hoáº·c lá»—i |
| 8 | KhÃ¡ch hÃ ng | Nháº¥n "Äáº·t HÃ ng" | Gá»i `POST /api/orders` |
| 9 | Backend | Thá»±c hiá»‡n giao dá»‹ch (nguyÃªn tá»­) | Táº¡o Ä‘Æ¡n hÃ ng, xÃ³a giá», Ã¡p dá»¥ng phiáº¿u |
| 10 | Backend | Gá»­i thÃ´ng bÃ¡o `NEW_ORDER` | Chá»§ quÃ¡n nháº­n thÃ´ng bÃ¡o Ä‘áº©y |
| 11 | Há»‡ thá»‘ng | Tráº£ vá» xÃ¡c nháº­n Ä‘Æ¡n hÃ ng | Äiá»u hÆ°á»›ng Ä‘áº¿n OrderSuccessScreen |

### 3.4 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `carts/{userId}/items` | Äá»c, XÃ³a | `productId`, `quantity`, `price`, `shopId` |
| `orders` | Táº¡o | `customerId`, `shopId`, `items[]`, `status`, `totalAmount`, `paymentMethod`, `deliveryAddress`, `voucherId` |
| `vouchers` | Äá»c, Cáº­p nháº­t | `usedCount` (tÄƒng) |
| `voucherUsage` | Táº¡o | `voucherId`, `userId`, `orderId`, `usedAt` |
| `shops` | Äá»c | `status` (xÃ¡c minh OPEN) |

### 3.5 ThÃ´ng BÃ¡o ÄÆ°á»£c KÃ­ch Hoáº¡t

| ThÃ´ng bÃ¡o | NgÆ°á»i nháº­n | Sá»± kiá»‡n kÃ­ch hoáº¡t |
|-----------|-----------|-----------------|
| `NEW_ORDER` | Chá»§ quÃ¡n | ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o |

### 3.6 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh Giá» HÃ ng | `pages/client/cart/CartScreen.kt` |
| Cart ViewModel | `pages/client/cart/CartViewModel.kt` |
| MÃ n hÃ¬nh Thanh ToÃ¡n | `pages/client/payment/PaymentScreen.kt` |
| Payment ViewModel | `pages/client/payment/PaymentViewModel.kt` |
| Backend Orders Service | `modules/orders/services/orders.service.ts` |

---

## 4. LUá»’NG NGÆ¯á»œI BÃN XÃC NHáº¬N & CHUáº¨N Bá»Š (SELLER CONFIRMS & PREPARES FLOW)

### 4.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SELLER CONFIRMS & PREPARES FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Owner receives NEW_ORDER notification]                                     â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ Tap notification or open app                                        â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚         ORDERS SCREEN (Pending tab)     â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   GET /orders/owner?status=PENDING       â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                â”‚
â”‚   â”‚   â”‚ Order #ORD-260130-0001          â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ Customer: Nguyen Van A          â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ Items: Phá»Ÿ bÃ² x 2, TrÃ  Ä‘Ã¡ x 1   â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ Total: 70,000Ä‘                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ [Confirm] [Reject]               â”‚   â”‚                                â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Tap "Confirm"                                          â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚  PATCH /orders/:id/confirm           â”‚                                   â”‚
â”‚   â”‚                                       â”‚                                   â”‚
â”‚   â”‚  â€¢ Update status â†’ CONFIRMED          â”‚                                   â”‚
â”‚   â”‚  â€¢ Send ORDER_CONFIRMED notification  â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Order moves to "Confirmed" tab                         â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚         ORDERS SCREEN (Confirmed tab)   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Start Preparing] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º PATCH /orders/:id/preparingâ”‚
â”‚   â”‚                                          â”‚â—„â”€â”€â”€ status â†’ PREPARING         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Order moves to "Preparing" tab                         â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚         ORDERS SCREEN (Preparing tab)   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Mark Ready] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º PATCH /orders/:id/ready   â”‚
â”‚   â”‚                                          â”‚â—„â”€â”€â”€ status â†’ READY             â”‚
â”‚   â”‚                                          â”‚     Send ORDER_READY notif     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Order visible to shippers                              â”‚
â”‚                      â–¼                                                        â”‚
â”‚               [Shipper accepts order]                                         â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | Chá»§ quÃ¡n (SELLER) |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | QuÃ¡n cÃ³ cÃ¡c Ä‘Æ¡n hÃ ng chá» xá»­ lÃ½, chá»§ quÃ¡n Ä‘Ã£ Ä‘Äƒng nháº­p |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | Chá»§ quÃ¡n nháº­n thÃ´ng bÃ¡o NEW_ORDER hoáº·c má»Ÿ mÃ n hÃ¬nh ÄÆ¡n HÃ ng |

### 4.3 CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n

| # | TÃ¡c nhÃ¢n | HÃ nh Ä‘á»™ng | Pháº£n há»“i há»‡ thá»‘ng |
|---|----------|-----------|-------------------|
| 1 | Chá»§ quÃ¡n | Má»Ÿ mÃ n hÃ¬nh ÄÆ¡n HÃ ng (tab Chá» Xá»­ LÃ½) | Táº£i Ä‘Æ¡n qua `GET /api/orders/owner?status=PENDING` |
| 2 | Chá»§ quÃ¡n | Xem chi tiáº¿t Ä‘Æ¡n hÃ ng | Hiá»ƒn thá»‹ sáº£n pháº©m, khÃ¡ch hÃ ng, tá»•ng tiá»n |
| 3 | Chá»§ quÃ¡n | Nháº¥n "XÃ¡c Nháº­n" | Gá»i `PATCH /api/orders/:id/confirm` |
| 4 | Backend | Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh CONFIRMED | Gá»­i thÃ´ng bÃ¡o `ORDER_CONFIRMED` cho khÃ¡ch hÃ ng |
| 5 | Chá»§ quÃ¡n | Nháº¥n "Báº¯t Äáº§u Chuáº©n Bá»‹" | Gá»i `PATCH /api/orders/:id/preparing` |
| 6 | Backend | Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh PREPARING | KhÃ´ng cÃ³ thÃ´ng bÃ¡o |
| 7 | Chá»§ quÃ¡n | Nháº¥n "ÄÃ¡nh Dáº¥u Sáºµn SÃ ng" | Gá»i `PATCH /api/orders/:id/ready` |
| 8 | Backend | Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh READY | Gá»­i `ORDER_READY` tá»›i khÃ¡ch hÃ ng + chá»§ Ä‘á» shipper |

### 4.4 MÃ¡y Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng

```
                          HÃ nh Ä‘á»™ng Chá»§ QuÃ¡n
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚                      â”‚
        â–¼                      â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚PENDING â”‚ confirm  â”‚CONFIRMED â”‚ preparingâ”‚PREPARING â”‚
    â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                                          â”‚
        â”‚ cancel                                   â”‚ ready
        â–¼                                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚CANCELLEDâ”‚                              â”‚  READY   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ (Shipper nháº­n Ä‘Æ¡n)
                                                   â–¼
                                             [Luá»“ng Shipper]
```

### 4.5 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `orders` | Äá»c, Cáº­p nháº­t | `status`, `confirmedAt`, `preparingAt`, `readyAt` |
| `users` | Äá»c | ThÃ´ng tin khÃ¡ch hÃ ng cho thÃ´ng bÃ¡o |

### 4.6 ThÃ´ng BÃ¡o ÄÆ°á»£c KÃ­ch Hoáº¡t

| HÃ nh Ä‘á»™ng | ThÃ´ng bÃ¡o | NgÆ°á»i nháº­n |
|-----------|-----------|-----------|
| `confirmOrder()` | `ORDER_CONFIRMED` | KhÃ¡ch hÃ ng |
| `markAsReady()` | `ORDER_READY` | KhÃ¡ch hÃ ng, FCM topic `shipper_available` |
| `cancelOrder()` | `ORDER_CANCELLED` | KhÃ¡ch hÃ ng |

### 4.7 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh ÄÆ¡n HÃ ng | `pages/owner/orders/OrdersScreen.kt` |
| Orders ViewModel | `pages/owner/orders/OrdersViewModel.kt` |
| Backend Orders Service | `modules/orders/services/orders-owner.service.ts` |

---

## 5. LUá»’NG SHIPPER NHáº¬N & GIAO HÃ€NG (SHIPPER PICKS UP & DELIVERS FLOW)

### 5.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SHIPPER PICKS UP & DELIVERS FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Shipper receives ORDER_READY notification]                                 â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ Open app or tap notification                                        â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   GPS SCREEN (Available Orders tab)     â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   GET /orders/shipper/available          â”‚                                â”‚
â”‚   â”‚   (filters by shipper's assigned shop)   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                â”‚
â”‚   â”‚   â”‚ Order #ORD-260130-0001          â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ Delivery: KTX Khu A, P.302      â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ Items: Phá»Ÿ bÃ² x 2               â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ [Accept Order] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â–º PATCH /orders/:id/accept  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Shipper accepts                                        â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚  Backend: Atomic order assignment     â”‚                                   â”‚
â”‚   â”‚                                       â”‚                                   â”‚
â”‚   â”‚  â€¢ Update order.shipperId             â”‚                                   â”‚
â”‚   â”‚  â€¢ Prevent race condition             â”‚                                   â”‚
â”‚   â”‚  â€¢ Send ORDER_SHIPPING notif          â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Order moves to "My Deliveries"                         â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   GPS SCREEN (Shipping Orders tab)      â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Start Trip] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º POST /gps/trips           â”‚
â”‚   â”‚                                          â”‚â—„â”€â”€â”€ { tripId }                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Trip created                                           â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚       DELIVERY MAP SCREEN               â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚      [Google Maps View]          â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   ğŸ“ Current location (live)     â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   ğŸª Shop pickup point           â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   ğŸ  Delivery destination        â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   â”€â”€â”€ Route polyline             â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Location tracking:                     â”‚                                â”‚
â”‚   â”‚   PATCH /gps/trips/:id/location          â”‚   (every 10 seconds)          â”‚
â”‚   â”‚   { lat, lng }                           â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Finish Delivery] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º POST /gps/trips/:id/finishâ”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚  Backend: Finish trip                 â”‚                                   â”‚
â”‚   â”‚                                       â”‚                                   â”‚
â”‚   â”‚  For each order in trip:              â”‚                                   â”‚
â”‚   â”‚  â€¢ Update status â†’ DELIVERED          â”‚                                   â”‚
â”‚   â”‚  â€¢ Increment soldCount (products)     â”‚                                   â”‚
â”‚   â”‚  â€¢ Credit shipper wallet              â”‚                                   â”‚
â”‚   â”‚  â€¢ Credit owner wallet                â”‚                                   â”‚
â”‚   â”‚  â€¢ Update buyer stats                 â”‚                                   â”‚
â”‚   â”‚  â€¢ Send ORDER_DELIVERED notif         â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | Shipper |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | Shipper Ä‘Æ°á»£c gÃ¡n cho quÃ¡n, cÃ¡c Ä‘Æ¡n hÃ ng á»Ÿ tráº¡ng thÃ¡i READY, shipper online |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | Shipper xem cÃ¡c Ä‘Æ¡n hÃ ng kháº£ dá»¥ng hoáº·c nháº­n thÃ´ng bÃ¡o ORDER_READY |

### 5.3 CÃ¡c BÆ°á»›c Thá»±c Hiá»‡n

| # | TÃ¡c nhÃ¢n | HÃ nh Ä‘á»™ng | Pháº£n há»“i há»‡ thá»‘ng |
|---|----------|-----------|-------------------|
| 1 | Shipper | Má»Ÿ mÃ n hÃ¬nh GPS (tab Kháº£ dá»¥ng) | Táº£i Ä‘Æ¡n qua `GET /api/orders/shipper/available` |
| 2 | Shipper | Nháº¥n "Cháº¥p Nháº­n ÄÆ¡n" | Gá»i `PATCH /api/orders/:id/accept` (nguyÃªn tá»­) |
| 3 | Backend | GÃ¡n Ä‘Æ¡n cho shipper | NgÄƒn cháº·n gÃ¡n Ä‘Ã´i, gá»­i thÃ´ng bÃ¡o `ORDER_SHIPPING` |
| 4 | Shipper | Nháº¥n "Báº¯t Äáº§u Chuyáº¿n" | Gá»i `POST /api/gps/trips` |
| 5 | Backend | Táº¡o chuyáº¿n, cáº­p nháº­t Ä‘Æ¡n thÃ nh SHIPPING | Tráº£ vá» ID chuyáº¿n |
| 6 | Shipper | Xem DeliveryMapScreen | Báº¯t Ä‘áº§u theo dÃµi vá»‹ trÃ­ |
| 7 | Há»‡ thá»‘ng | Gá»­i cáº­p nháº­t vá»‹ trÃ­ | Gá»i `PATCH /api/gps/trips/:id/location` má»—i 10 giÃ¢y |
| 8 | Shipper | Giao hÃ ng, nháº¥n "HoÃ n ThÃ nh Giao HÃ ng" | Gá»i `POST /api/gps/trips/:id/finish` |
| 9 | Backend | ÄÃ¡nh dáº¥u Ä‘Æ¡n DELIVERED | Cáº­p nháº­t soldCount, vÃ­ tiá»n, thá»‘ng kÃª |
| 10 | Backend | Gá»­i thÃ´ng bÃ¡o `ORDER_DELIVERED` | KhÃ¡ch hÃ ng nháº­n thÃ´ng bÃ¡o Ä‘áº©y |

### 5.4 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `orders` | Äá»c, Cáº­p nháº­t | `shipperId`, `status`, `deliveredAt` |
| `trips` | Táº¡o, Cáº­p nháº­t | `shipperId`, `orderIds[]`, `status`, `route[]`, `currentLocation` |
| `products` | Cáº­p nháº­t | `soldCount` (tÄƒng) |
| `wallets` | Cáº­p nháº­t | Sá»‘ dÆ° chá»§ quÃ¡n, sá»‘ dÆ° shipper |
| `wallets/{id}/transactions` | Táº¡o | Ghi ná»£ giao dá»‹ch |

### 5.5 ThÃ´ng BÃ¡o ÄÆ°á»£c KÃ­ch Hoáº¡t

| HÃ nh Ä‘á»™ng | ThÃ´ng bÃ¡o | NgÆ°á»i nháº­n |
|-----------|-----------|-----------|
| `acceptOrder()` | `ORDER_SHIPPING` | KhÃ¡ch hÃ ng |
| `finishTrip()` | `ORDER_DELIVERED` | KhÃ¡ch hÃ ng |

### 5.6 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh GPS | `pages/shipper/gps/GpsScreen.kt` |
| GPS ViewModel | `pages/shipper/gps/GpsViewModel.kt` |
| Báº£n Äá»“ Giao HÃ ng | `pages/shipper/gps/DeliveryMapScreen.kt` |
| Backend GPS Service | `modules/gps/services/gps.service.ts` |
| Backend Orders Shipper Service | `modules/orders/services/orders-shipper.service.ts` |

---

## 6. LUá»’NG THÃ”NG BÃO (NOTIFICATION FLOW)

### 6.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NOTIFICATION FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Trigger Event in Backend]                                                  â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ e.g., OrdersService.createOrder()                                   â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   NotificationsService.send({           â”‚                                â”‚
â”‚   â”‚     userId: ownerId,                    â”‚                                â”‚
â”‚   â”‚     type: 'NEW_ORDER',                  â”‚                                â”‚
â”‚   â”‚     title: 'ÄÆ¡n hÃ ng má»›i!',             â”‚                                â”‚
â”‚   â”‚     body: 'Báº¡n cÃ³ Ä‘Æ¡n hÃ ng má»›i...',     â”‚                                â”‚
â”‚   â”‚     data: { orderId }                   â”‚                                â”‚
â”‚   â”‚   })                                    â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                      â”‚                                  â”‚                    â”‚
â”‚                      â–¼                                  â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚   FIRESTORE                 â”‚    â”‚   FIREBASE CLOUD MESSAGING  â”‚        â”‚
â”‚   â”‚                             â”‚    â”‚                              â”‚        â”‚
â”‚   â”‚   notifications/{userId}/   â”‚    â”‚   1. Get FCM tokens from    â”‚        â”‚
â”‚   â”‚   notifications/{notifId}   â”‚    â”‚      users/{userId}/fcmTokensâ”‚        â”‚
â”‚   â”‚                             â”‚    â”‚                              â”‚        â”‚
â”‚   â”‚   {                         â”‚    â”‚   2. firebase.messaging()    â”‚        â”‚
â”‚   â”‚     type: 'NEW_ORDER',      â”‚    â”‚      .sendEachForMulticast() â”‚        â”‚
â”‚   â”‚     title: '...',           â”‚    â”‚                              â”‚        â”‚
â”‚   â”‚     body: '...',            â”‚    â”‚   3. Handle failed tokens    â”‚        â”‚
â”‚   â”‚     isRead: false,          â”‚    â”‚      (remove stale tokens)   â”‚        â”‚
â”‚   â”‚     createdAt: ...          â”‚    â”‚                              â”‚        â”‚
â”‚   â”‚   }                         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚                        â”‚
â”‚                                                      â”‚                        â”‚
â”‚                                                      â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        ANDROID DEVICE                                 â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚   â”‚   â”‚   FirebaseMessagingService                                     â”‚ â”‚  â”‚
â”‚   â”‚   â”‚                                                                â”‚ â”‚  â”‚
â”‚   â”‚   â”‚   onMessageReceived(remoteMessage)                             â”‚ â”‚  â”‚
â”‚   â”‚   â”‚     â€¢ Extract notification data                                â”‚ â”‚  â”‚
â”‚   â”‚   â”‚     â€¢ Show system notification                                 â”‚ â”‚  â”‚
â”‚   â”‚   â”‚     â€¢ Handle tap â†’ navigate to relevant screen                 â”‚ â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   [User opens Notifications screen]                                   â”‚  â”‚
â”‚   â”‚         â”‚                                                             â”‚  â”‚
â”‚   â”‚         â–¼                                                             â”‚  â”‚
â”‚   â”‚   GET /notifications                                                  â”‚  â”‚
â”‚   â”‚   (Firestore listener or REST)                                        â”‚  â”‚
â”‚   â”‚         â”‚                                                             â”‚  â”‚
â”‚   â”‚         â–¼                                                             â”‚  â”‚
â”‚   â”‚   Display notification list with read/unread status                   â”‚  â”‚
â”‚   â”‚         â”‚                                                             â”‚  â”‚
â”‚   â”‚         â”‚ Tap notification                                            â”‚  â”‚
â”‚   â”‚         â–¼                                                             â”‚  â”‚
â”‚   â”‚   PATCH /notifications/:id/read                                       â”‚  â”‚
â”‚   â”‚   + Navigate to relevant screen (e.g., order detail)                  â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 CÃ¡c Loáº¡i ThÃ´ng BÃ¡o & Sá»± Kiá»‡n KÃ­ch Hoáº¡t

| Loáº¡i | Sá»± kiá»‡n kÃ­ch hoáº¡t | NgÆ°á»i gá»­i | NgÆ°á»i nháº­n |
|------|------------------|-----------|-----------|
| `NEW_ORDER` | `OrdersService.createOrder()` | Há»‡ thá»‘ng | Chá»§ quÃ¡n |
| `ORDER_CONFIRMED` | `OrdersOwnerService.confirmOrder()` | HÃ nh Ä‘á»™ng chá»§ quÃ¡n | KhÃ¡ch hÃ ng |
| `ORDER_READY` | `OrdersOwnerService.markAsReady()` | HÃ nh Ä‘á»™ng chá»§ quÃ¡n | KhÃ¡ch hÃ ng + Shipper topic |
| `ORDER_SHIPPING` | `OrdersShipperService.acceptOrder()` | HÃ nh Ä‘á»™ng shipper | KhÃ¡ch hÃ ng |
| `ORDER_DELIVERED` | `GpsService.finishTrip()` | HÃ nh Ä‘á»™ng shipper | KhÃ¡ch hÃ ng |
| `ORDER_CANCELLED` | `OrdersService.cancelOrder()` | HÃ nh Ä‘á»™ng chá»§ quÃ¡n/khÃ¡ch hÃ ng | KhÃ¡ch hÃ ng/Chá»§ quÃ¡n |
| `APPLICATION_APPROVED` | `ShippersService.approveApplication()` | HÃ nh Ä‘á»™ng chá»§ quÃ¡n | Shipper |
| `APPLICATION_REJECTED` | `ShippersService.rejectApplication()` | HÃ nh Ä‘á»™ng chá»§ quÃ¡n | Shipper |
| `PAYMENT_SUCCESS` | `PaymentsService.confirmPayment()` | Há»‡ thá»‘ng | KhÃ¡ch hÃ ng |

### 6.3 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `users/{userId}/fcmTokens` | Äá»c | Token thiáº¿t bá»‹ FCM |
| `notifications/{userId}/notifications` | Táº¡o, Cáº­p nháº­t | `type`, `title`, `body`, `isRead`, `data`, `createdAt` |

### 6.4 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| Notifications Service | `modules/notifications/services/notifications.service.ts` |
| Firebase Service | `shared/services/firebase.service.ts` |
| Android Notifications Screen | `pages/client/notifications/NotificationsScreen.kt` (khÃ¡ch hÃ ng) |
| Android Notifications Screen | `pages/shipper/notifications/NotificationsScreen.kt` (shipper) |

---

## 7. LUá»’NG CHAT (CHAT FLOW)

### 7.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CHAT FLOW                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Customer on Product Detail Screen]                                         â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ Tap "Chat with Shop"                                                â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   POST /chat/conversations              â”‚                                â”‚
â”‚   â”‚   {                                     â”‚                                â”‚
â”‚   â”‚     customerId: "...",                  â”‚                                â”‚
â”‚   â”‚     shopId: "..."                       â”‚                                â”‚
â”‚   â”‚   }                                     â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Backend:                               â”‚                                â”‚
â”‚   â”‚   â€¢ Check if conversation exists         â”‚                                â”‚
â”‚   â”‚   â€¢ If not, create new conversation      â”‚                                â”‚
â”‚   â”‚   â€¢ Return conversation ID               â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚           CHAT SCREEN                   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   GET /chat/conversations/:id/messages   â”‚                                â”‚
â”‚   â”‚   (or Firestore real-time listener)      â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                â”‚
â”‚   â”‚   â”‚ ğŸ’¬ Shop: Xin chÃ o!              â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚              CÃ³ Phá»Ÿ bÃ² khÃ´ng? ğŸ’¬ â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚ ğŸ’¬ Shop: CÃ³ áº¡, cÃ²n 5 pháº§n      â”‚   â”‚                                â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   [Type message...]  [Send] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º POST /.../messages        â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   Backend: Create message               â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â€¢ Add to conversations/{id}/messages   â”‚                                â”‚
â”‚   â”‚   â€¢ Update conversation.lastMessage      â”‚                                â”‚
â”‚   â”‚   â€¢ (Optional) Send push notification    â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â”‚   [Owner's Device - Real-time sync via Firestore listener]                    â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   OWNER CHAT SCREEN                     â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   New message appears instantly          â”‚                                â”‚
â”‚   â”‚   (Firestore onSnapshot listener)        â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Owner replies â†’ same flow              â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | KhÃ¡ch hÃ ng â†” Chá»§ quÃ¡n |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | Cáº£ hai ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | KhÃ¡ch hÃ ng nháº¥n "Chat vá»›i QuÃ¡n" |

### 7.3 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `conversations` | Táº¡o/Äá»c | `participants[]`, `lastMessage`, `updatedAt` |
| `conversations/{id}/messages` | Táº¡o/Äá»c | `senderId`, `text`, `timestamp`, `read` |

### 7.4 Quy Táº¯c Báº£o Máº­t (Báº±ng Chá»©ng)

Tá»« `firestore.rules`:
```javascript
match /conversations/{conversationId} {
  allow read: if isAuthenticated() && 
                 request.auth.uid in resource.data.participants;
  allow create: if isAuthenticated() && 
                   request.auth.uid in request.resource.data.participants;
  allow update: if isAuthenticated() && 
                   request.auth.uid in resource.data.participants;
  
  match /messages/{messageId} {
    allow read: if isAuthenticated() && 
                   request.auth.uid in get(.../conversations/$(conversationId)).data.participants;
    allow create: if isAuthenticated() && 
                     request.auth.uid in get(.../conversations/$(conversationId)).data.participants &&
                     request.resource.data.senderId == request.auth.uid;
  }
}
```

### 7.5 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| MÃ n hÃ¬nh Chat KhÃ¡ch HÃ ng | `pages/client/chat/ChatScreen.kt` |
| Danh SÃ¡ch Chat KhÃ¡ch HÃ ng | `pages/client/listchat/ListChatScreen.kt` |
| MÃ n hÃ¬nh Chat Chá»§ QuÃ¡n | `pages/owner/chat/OwnerChatDetailScreen.kt` |
| Danh SÃ¡ch Chat Chá»§ QuÃ¡n | `pages/owner/chat/OwnerConversationsScreen.kt` |
| Backend Chat Service | `modules/chat/chat.service.ts` |

---

## 8. LUá»’NG THEO DÃ•I GPS (GPS TRACKING FLOW)

### 8.1 SÆ¡ Äá»“ Luá»“ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GPS TRACKING FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   [Shipper starts trip]                                                       â”‚
â”‚         â”‚                                                                     â”‚
â”‚         â”‚ POST /gps/trips/:id/start                                           â”‚
â”‚         â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   GpsViewModel.startLocationTracking()  â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   1. Check location permissions          â”‚                                â”‚
â”‚   â”‚   2. Get FusedLocationProviderClient     â”‚                                â”‚
â”‚   â”‚   3. Request location updates            â”‚                                â”‚
â”‚   â”‚      - interval: 10 seconds              â”‚                                â”‚
â”‚   â”‚      - priority: HIGH_ACCURACY           â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Location callback triggered                            â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   onLocationResult(location)            â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   PATCH /gps/trips/:id/location         â”‚                                â”‚
â”‚   â”‚   {                                     â”‚                                â”‚
â”‚   â”‚     lat: 10.8714,                       â”‚                                â”‚
â”‚   â”‚     lng: 106.8032                       â”‚                                â”‚
â”‚   â”‚   }                                     â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   Backend: GpsService.updateLocation()  â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Firestore update:                      â”‚                                â”‚
â”‚   â”‚   trips/{tripId}.currentLocation = {     â”‚                                â”‚
â”‚   â”‚     lat: 10.8714,                        â”‚                                â”‚
â”‚   â”‚     lng: 106.8032,                       â”‚                                â”‚
â”‚   â”‚     timestamp: ...                       â”‚                                â”‚
â”‚   â”‚   }                                      â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                        â”‚
â”‚                      â”‚ Firestore real-time listener                           â”‚
â”‚                      â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚   â”‚   CUSTOMER ORDER TRACKING SCREEN        â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   GET /gps/trips/order/:orderId         â”‚                                â”‚
â”‚   â”‚   + Firestore listener on trip doc       â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚      [Google Maps View]          â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   ğŸ›µ Shipper (real-time)         â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   â”€â”€â”€ Route                      â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚   ğŸ  Your location               â”‚   â”‚                                â”‚
â”‚   â”‚   â”‚                                  â”‚   â”‚                                â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â”‚   Shipper: Nguyen Van B                  â”‚                                â”‚
â”‚   â”‚   Status: On the way (2 km away)         â”‚                                â”‚
â”‚   â”‚                                          â”‚                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Chi Tiáº¿t Luá»“ng

| KhÃ­a cáº¡nh | Chi tiáº¿t |
|-----------|----------|
| **TÃ¡c nhÃ¢n** | Shipper (ngÆ°á»i gá»­i), KhÃ¡ch hÃ ng (ngÆ°á»i xem) |
| **Äiá»u kiá»‡n tiÃªn quyáº¿t** | Chuyáº¿n Ä‘Ã£ báº¯t Ä‘áº§u, Ä‘Ã£ cáº¥p quyá»n vá»‹ trÃ­ |
| **Sá»± kiá»‡n kÃ­ch hoáº¡t** | Shipper báº¯t Ä‘áº§u chuyáº¿n |

### 8.3 Thiáº¿t Láº­p Vá»‹ TrÃ­ Android

```xml
<!-- AndroidManifest.xml -->
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
```

### 8.4 Dá»¯ Liá»‡u ÄÆ°á»£c Truy Cáº­p

| Collection | Thao tÃ¡c | TrÆ°á»ng dá»¯ liá»‡u |
|------------|----------|----------------|
| `trips` | Äá»c, Cáº­p nháº­t | `currentLocation`, `route[]`, `status` |
| `orders` | Äá»c | Tra cá»©u theo dÃµi khÃ¡ch hÃ ng |

### 8.5 Tham Chiáº¿u MÃ£ Nguá»“n

| ThÃ nh pháº§n | Tá»‡p |
|-----------|------|
| GPS ViewModel | `pages/shipper/gps/GpsViewModel.kt` |
| MÃ n hÃ¬nh Báº£n Äá»“ Giao HÃ ng | `pages/shipper/gps/DeliveryMapScreen.kt` |
| Location Helper | `utils/LocationHelper.kt` |
| Backend GPS Service | `modules/gps/services/gps.service.ts` |

---

## 9. Háº N CHáº¾ ÄÃƒ BIáº¾T (KNOWN LIMITATIONS)

### 9.1 TODOs TÃ¬m Tháº¥y Trong MÃ£

| Tá»‡p | DÃ²ng | Ná»™i dung TODO |
|-----|------|--------------|
| `DeliveryMapScreen.kt` | 541 | `/* TODO: Open Google Maps navigation */` |
| `ReviewViewModel.kt` | 144 | `// TODO: Implement API delete review` |
| `ReviewScreen.kt` | 236 | `// TODO: Implement edit review` |
| `UserProfileViewModel.kt` | 408 | `// TODO: Implement logic láº¥y token tá»« AuthManager` |
| `OrderDetailViewModel.kt` | 129 | `// TODO: Implement API check if order has been reviewed` |
| `ListChatScreen.kt` | 313 | `// TODO: Bá»• sung logic kiá»ƒm tra tin nháº¯n chÆ°a Ä‘á»c` |
| `auth.service.ts` | 503 | `// TODO: Consider requiring reauthentication` |
| `orders-owner.service.spec.ts` | 414 | `// TODO: When payment service available, verify refund is called` |
| `orders-role-access.e2e.spec.ts` | 30-35 | Multiple `[TODO]` test placeholders |

### 9.2 TÃ­nh NÄƒng Thiáº¿u/ChÆ°a HoÃ n Thiá»‡n

| TÃ­nh nÄƒng | Tráº¡ng thÃ¡i | Ghi chÃº |
|----------|-----------|--------|
| **Google Maps Navigation** | âš ï¸ BÃ¡n pháº§n | NÃºt tá»“n táº¡i, nhÆ°ng Ä‘iá»u hÆ°á»›ng chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t |
| **Edit/Delete Review** | âŒ ChÆ°a triá»ƒn khai | UI tá»“n táº¡i, API chÆ°a káº¿t ná»‘i |
| **Unread Message Count** | âš ï¸ BÃ¡n pháº§n | Logic Ä‘Æ°á»£c Ä‘á» cáº­p lÃ  TODO |
| **Refund System** | âŒ ChÆ°a triá»ƒn khai | KhÃ´ng cÃ³ quy trÃ¬nh hoÃ n tiá»n |
| **Offline Mode** | âŒ ChÆ°a triá»ƒn khai | KhÃ´ng cÃ³ chiáº¿n lÆ°á»£c bá»™ nhá»› Ä‘á»‡m cá»¥c bá»™ |
| **Dark Mode** | âŒ ChÆ°a triá»ƒn khai | Chá»‰ cÃ³ má»™t chá»§ Ä‘á» |
| **Multi-store per Owner** | âŒ ChÆ°a triá»ƒn khai | Má»™t chá»§ quÃ¡n = má»™t cá»­a hÃ ng |
| **Scheduled Orders** | âŒ ChÆ°a triá»ƒn khai | KhÃ´ng cÃ³ Ä‘áº·t hÃ ng trong tÆ°Æ¡ng lai |
| **WebSocket Real-time** | âš ï¸ BÃ¡n pháº§n | Sá»­ dá»¥ng Firestore listeners + polling |

### 9.3 Ná»£ Ká»¹ Thuáº­t ÄÃ£ Biáº¿t

| Khu vá»±c | Váº¥n Ä‘á» | Báº±ng chá»©ng |
|--------|-------|-----------|
| **Dependency Injection** | MÃ´ hÃ¬nh factory thá»§ cÃ´ng | `LoginViewModel.factory()` thay vÃ¬ Hilt/Koin |
| **Image Compression** | KhÃ´ng cÃ³ | HÃ¬nh áº£nh Ä‘Æ°á»£c táº£i lÃªn nguyÃªn gá»‘c (rÃ² rá»‰ bá»™ nhá»› tiá»m tÃ ng) |
| **Test Coverage** | ChÆ°a hoÃ n chá»‰nh | E2E tests cÃ³ `[TODO]` placeholders |
| **API Versioning** | ChÆ°a triá»ƒn khai | PhiÃªn báº£n API duy nháº¥t |
| **Rate Limiting** | ChÆ°a triá»ƒn khai | KhÃ´ng cÃ³ Ä‘iá»u chá»‰nh tá»‘c Ä‘á»™ yÃªu cáº§u |

### 9.4 RÃ ng Buá»™c Logic Kinh Doanh

| RÃ ng buá»™c | MÃ´ táº£ | Báº±ng chá»©ng |
|-----------|-------|-----------|
| **Free Shipping** | KhÃ¡ch hÃ ng luÃ´n tráº£ 0Ä‘ cho váº­n chuyá»ƒn | `shipperPayout` káº¿ toÃ¡n ná»™i bá»™ |
| **Single Shop** | Má»™t chá»§ quÃ¡n chá»‰ cÃ³ thá»ƒ cÃ³ má»™t cá»­a hÃ ng | KhÃ´ng há»— trá»£ nhiá»u cá»­a hÃ ng trong schema |
| **Manual Payout** | Admin pháº£i phÃª duyá»‡t lÆ°Æ¡ng | KhÃ´ng cÃ³ há»‡ thá»‘ng thanh toÃ¡n tá»± Ä‘á»™ng |
| **No WebSocket** | Real-time dá»±a vÃ o Firestore | Polling cho tráº¡ng thÃ¡i thanh toÃ¡n |

---

## TÃ“summary CHI TIáº¾T THAM CHIáº¾U Tá»†P

| Luá»“ng | CÃ¡c Tá»‡p ChÃ­nh |
|------|--------------|
| **XÃ¡c Thá»±c** | `authentication/login/`, `modules/auth/` |
| **Duyá»‡t/Menu** | `pages/client/home/`, `pages/client/shop/` |
| **Giá»/Thanh ToÃ¡n** | `pages/client/cart/`, `pages/client/payment/`, `modules/orders/` |
| **ÄÆ¡n Chá»§ QuÃ¡n** | `pages/owner/orders/`, `modules/orders/services/orders-owner.service.ts` |
| **Giao HÃ ng Shipper** | `pages/shipper/gps/`, `modules/gps/`, `modules/orders/services/orders-shipper.service.ts` |
| **ThÃ´ng BÃ¡o** | `modules/notifications/`, `shared/services/firebase.service.ts` |
| **Chat** | `pages/*/chat/`, `modules/chat/` |
| **GPS** | `pages/shipper/gps/`, `utils/LocationHelper.kt`, `modules/gps/` |

---

**Káº¾T THÃšC LUá»’NG Xá»¬ LÃ CHÃNH**
